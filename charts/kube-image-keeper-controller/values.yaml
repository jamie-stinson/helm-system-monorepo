namespace: "kube-image-keeper"
installCRDs: true

workload:
  image:
    registry: ghcr.io
    repository: enix/kube-image-keeper
    tag: 1.13.1
  command:
    - manager
  args:
    - '-proxy-port=7439'
    - '-registry-endpoint=kube-image-keeper-registry.kube-image-keeper.svc.cluster.local:5000'
    - '-leader-elect'
    - '-expiry-delay=30'
    - '-max-concurrent-cached-image-reconciles=3'
    - '-zap-log-level=INFO'
    - '-ignore-pull-policy-always=true'
    - '-arch=amd64'
  probes:
    readinessProbe:
      port: 8081
    livenessProbe:
      path: "/healthz"
      port: 8081
  storage:
    - name: kube-image-keeper-controller-certificate
      type: secret
      mountPath: /tmp/k8s-webhook-server/serving-certs
      secretName: kube-image-keeper-controller-certificate

service:
  ports:
    - name: http
      port: 9443
      protocol: TCP
    - name: http-metrics
      port: 8080
      protocol: TCP

certificate:
  enabled: true
  spec:
    dnsNames:
      - kube-image-keeper-controller.kube-image-keeper.svc
      - kube-image-keeper-controller.kube-image-keeper.svc.cluster.local
    issuerRef:
      kind: Issuer
      name: kube-image-keeper-controller
    secretName: kube-image-keeper-controller-certificate

issuer:
  enabled: true
  type: Issuer
  spec:
    selfSigned: {}

rbac:
  enabled: true
  roles:
    clusterRole:
      rules:
        - apiGroups:
            - ''
          resources:
            - events
          verbs:
            - create
            - patch
        - apiGroups:
            - ''
          resources:
            - pods
          verbs:
            - create
            - delete
            - get
            - list
            - patch
            - update
            - watch
        - apiGroups:
            - ''
          resources:
            - serviceaccounts
          verbs:
            - list
            - watch
        - apiGroups:
            - ''
          resources:
            - pods/finalizers
          verbs:
            - update
        - apiGroups:
            - ''
          resources:
            - pods/status
          verbs:
            - get
            - patch
            - update
        - apiGroups:
            - ''
          resources:
            - secrets
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - kuik.enix.io
          resources:
            - cachedimages
          verbs:
            - create
            - delete
            - get
            - list
            - patch
            - update
            - watch
        - apiGroups:
            - kuik.enix.io
          resources:
            - cachedimages/finalizers
          verbs:
            - update
        - apiGroups:
            - kuik.enix.io
          resources:
            - cachedimages/status
          verbs:
            - get
            - patch
            - update
        - apiGroups:
            - kuik.enix.io
          resources:
            - repositories
          verbs:
            - create
            - delete
            - get
            - list
            - patch
            - update
            - watch
        - apiGroups:
            - kuik.enix.io
          resources:
            - repositories/finalizers
          verbs:
            - update
        - apiGroups:
            - kuik.enix.io
          resources:
            - repositories/status
          verbs:
            - get
            - patch
            - update
        - apiGroups:
            - ''
          resources:
            - configmaps
          verbs:
            - get
            - list
            - watch
            - create
            - update
            - patch
            - delete
        - apiGroups:
            - coordination.k8s.io
          resources:
            - leases
          verbs:
            - get
            - list
            - watch
            - create
            - update
            - patch
            - delete
        - apiGroups:
            - ''
          resources:
            - events
          verbs:
            - create
            - patch

grafana:
  dashboard:
    enabled: true
    dashboards:
      - name: kubernetes-image-cache
        title: "Kubernetes / Image Cache"
        url: "https://raw.githubusercontent.com/jamie-stinson/helm-system-monorepo/refs/heads/main/charts/kube-image-keeper-controller/dashboards/kubernetes-image-cache.json"
        folder: "System"

extraObjects:
  - |
    apiVersion: bitnami.com/v1alpha1
    kind: SealedSecret
    metadata:
      name: secret-name
      namespace: kube-image-keeper
    spec:
      encryptedData:
        accessKey: AgBhKA2lNfNoVhTX/XzA1RjA9fvZoWMeIjYi3+ia9Vq26/c3fhm3BMiHyNbKo1DYwHYLLsXV7bIOUUS4QRugeyvuSydBmSh0LiO2z1DIzBPUiDuVLwyzzrDqSEBsRuxt1kK279UVQxppcFHYAhU+JmdyhgwVZzhU/A6DywVNJoYU2m1mz8CgmoebKVmYHFmIcToKGM58WAp6grqfkRiV5cSDT/RFaTREFkr6B6VElJo6f8MSgiMTseaeoQ3D2K+X7D8rXxzEBj5ylXU73XSUOLhCxXmmhDNZe4Fjy3V8NNNJtRmcyIsPvkKydAnE9/Jws1Kdmw0Q/gYFo+q3+M6/ggFqMmiXpnkbG70OaqI/gKSzW6V9Zx6OEQ5Sd/rrtjuLd9ST4hxF7KN147POW84QbpUoUpIco2LDvjiQsxQiXanEZPqewsVuBaabUfP2zVxpAM93qENslU4RJmyojX4qx9E324alaTuSkP4wRZnR5WzhJJHnLcZ9T8SYDadAGWB8uxF39Wls2pW6xJpAgddLBF2uB0PxuD4hnzyymd/lXmM3Xs4nq13/NB6W6M62IGChm+2B6qCuF+e8wmnvuDgiTZT6fsZTWa8ymYPuCcvlkFah21TpaBT5HJoSJO8WKwdbNLFp9Pfb7ZAK/Zd/jjYdkrXTIvA2c08q/fmujf7J8yBq2IsT9MazDlST6owWiRd4sPMU4YIbVXlI/hqXnMdv5AyB6LDdFQ==
        secretKey: AgBtk6Mtbe2bwHV/EQSP3L/km/iRMF7QYUmmyyOKo39mW/FlUHUacJQlrjfc2WabVDGfy3Gis8GgwGzy7po4W4I6XVmLtcUoCbQw6WVjbudtSMn9sGqOuAadQev5+zHvGqqHI/Cbvl12GFRcroEnE4FqclVKrZZMGmnfyOMmmjNMs1/lL4vKskHu2ibbAL4r/26ZdEQE/9i399P2r+g6euY3MRGyX8QKWu9zYqAf7HGP6cN3ZU7LZ50yi4pmDa1fXMu8Y8uEmVH4FEsjjjB7L2PCmzPyO9W4/IshZDkUlhQriwmxurgpKf7EjScDXS6LDXI/9Wepi1KosqCPEN1iaXKGo71E3rAaCsVBUmc6gntK5ok2/yw6QCMF0ieZvzM4zQedi5D0hfyYJpzBSdhMq+aahJphT2hxOWp4+JcbViV9SQlu62AKlaVfltCvhdDw3dvzgAN8ER8EMDmJapHFwkDalPCfa8ZPwsyDKqvsw2C/ir6D0ek6v1BDHIiP1803uqtU94OAYVvALL20f/uIRtFD5kEmgzFmzipOYnqTbWgMNea629GWtDSdMGt924wlkO47nXqe2vbz6sz2bSBdjDiXSAhYLpuG3Wug/PGFIsJbb4TgLN0ZXHbAi32d/c5Qp93RC+qDJavfAvlMfCKwczHdM3kUygbgubb+qU4ntCRJkkyZds63vnBbKp9o+jcX/jLe1xeOoIXnjsPp2ojz3zSzDGWxh2jTLt4C1AvRg7RipPxbIppXxnU=
      template:
        metadata:
          name: secret-name
          namespace: kube-image-keeper
        type: Opaque
  - |
    apiVersion: admissionregistration.k8s.io/v1
    kind: MutatingWebhookConfiguration
    metadata:
      annotations:
        cert-manager.io/inject-ca-from: kube-image-keeper/kube-image-keeper-controller
      name: kube-image-keeper-controller
    webhooks:
      - admissionReviewVersions:
          - v1
          - v1beta1
        clientConfig:
          service:
            name: kube-image-keeper-controller
            namespace: kube-image-keeper
            path: /mutate-core-v1-pod
            port: 9443
        failurePolicy: Ignore
        name: mpod.kb.io
        namespaceSelector:
          matchExpressions:
            - key: kubernetes.io/metadata.name
              operator: NotIn
              values:
                - kube-system
                - kube-image-keeper
                - openebs
                - minio
        objectSelector:
          matchExpressions:
            - key: kube-image-keeper.enix.io/image-caching-policy
              operator: NotIn
              values:
                - ignore
        reinvocationPolicy: IfNeeded
        rules:
          - apiGroups:
              - ''
            apiVersions:
              - v1
            operations:
              - CREATE
              - UPDATE
            resources:
              - pods
        sideEffects: None
      - admissionReviewVersions:
          - v1
        clientConfig:
          service:
            name: kube-image-keeper-controller
            namespace: kube-image-keeper
            path: /mutate-kuik-enix-io-v1alpha1-cachedimage
            port: 9443
        failurePolicy: Fail
        name: mcachedimage.kb.io
        rules:
          - apiGroups:
              - kuik.enix.io
            apiVersions:
              - v1alpha1
            operations:
              - CREATE
              - UPDATE
            resources:
              - cachedimages
        sideEffects: None
