workload:
  replicaCount: 1
  image:
    repository: "grafana/promtail"
    tag: "latest"
  resources:
    preset: "micro"
  args:
    - '-config.file=/etc/promtail/config.yaml'
  storage:
    - name: config
      type: configMap
      mountPath: /etc/promtail
      configMapName: promtail
    - name: logs
      type: hostPath
      mountPath: /var/log
      hostPath: /var/log
      readOnly: true
service:
  ports:
    - name: http
      protocol: TCP
      port: 9080

autoscaling:
  enabled: false

configMap:
  enabled: true
  data:
    config.yaml: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://loki.loki.svc.cluster.local:3100/loki/api/v1/push

      scrape_configs:
      - job_name: system
        static_configs:
        - targets:
            - "localhost"
          labels:
            job: varlogs
            __path__: /var/log/*log

      - job_name: kubernetes-pods
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels:
          - __meta_kubernetes_pod_node_name
          target_label: __host__
        - action: drop
          regex: ^$
          source_labels:
          - __meta_kubernetes_pod_label_name
        - action: replace
          replacement: $1
          separator: /
          source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_pod_label_name
          target_label: job
        - action: replace
          source_labels:
          - __meta_kubernetes_namespace
          target_label: namespace
        - action: replace
          source_labels:
          - __meta_kubernetes_pod_name
          target_label: instance
        - replacement: /var/log/pods/$1
          separator: /
          source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
          target_label: __path__
      - job_name: kubernetes-pods-app
        kubernetes_sd_configs:
        - role: pod
        relabel_configs:
        - source_labels:
          - __meta_kubernetes_pod_node_name
          target_label: __host__
        - action: drop
          regex: ^$
          source_labels:
          - __meta_kubernetes_pod_label_app
        - action: replace
          replacement: $1
          separator: /
          source_labels:
          - __meta_kubernetes_namespace
          - __meta_kubernetes_pod_label_app
          target_label: job
        - action: replace
          source_labels:
          - __meta_kubernetes_namespace
          target_label: namespace
        - action: replace
          source_labels:
          - __meta_kubernetes_pod_name
          target_label: instance
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - replacement: /var/log/pods/$1
          separator: /
          source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
          target_label: __path__

rbac:
  enabled: true
  roles:
    clusterRole:
      rules:
        - apiGroups: [""]
          resources:
          - nodes
          - nodes/proxy
          - services
          - endpoints
          - pods  
          verbs: ["get", "watch", "list"]

ingress:
  enabled: true
  entryPoints:
    - internalwebsecure
    - internalweb
  port: http
  prefix: "promtail"
  tls: true
